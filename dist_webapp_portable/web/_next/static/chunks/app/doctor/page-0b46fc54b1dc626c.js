(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[328],{382:(e,t,a)=>{"use strict";a.d(t,{PortalCard:()=>r,Z:()=>l,r:()=>c});var i=a(5155),n=a(6874),s=a.n(n);function l(e){let{title:t,subtitle:a,className:n="",children:s}=e;return(0,i.jsxs)("section",{className:"panel ".concat(n).trim(),children:[(t||a)&&(0,i.jsxs)("header",{className:"panel-header",children:[t?(0,i.jsx)("h2",{children:t}):null,a?(0,i.jsx)("p",{children:a}):null]}),s]})}function r(e){return(0,i.jsxs)(s(),{className:"portal-card",href:e.href,style:{"--accent":e.accent},children:[(0,i.jsx)("div",{className:"portal-card__bar"}),(0,i.jsx)("h3",{children:e.title}),(0,i.jsx)("p",{children:e.description}),(0,i.jsx)("span",{className:"portal-card__cta",children:"Open workspace"})]})}function c(e){let{children:t}=e;return(0,i.jsx)("p",{className:"small-meta",children:t})}},4860:(e,t,a)=>{"use strict";a.d(t,{XN:()=>u,_o:()=>p,b0:()=>m,je:()=>h,tk:()=>d});var i=a(5731);let n="copilot.portal.role",s="copilot.portal.login_at",l="copilot.portal.boot_cleaned";function r(e){return"doctor"===e||"assistant"===e}function c(e){window.localStorage.setItem(n,e),window.localStorage.setItem(s,new Date().toISOString())}function o(){window.localStorage.removeItem(n),window.localStorage.removeItem(s)}function d(e,t){let a=(t||"").toLowerCase().replace(/[^a-z]/g,"");return"doctor"===a?"doctor"===e?"/doctor/":"/assistant/":"assistant"===a?"/assistant/":"doctor"===e?"/doctor/":"/assistant/"}async function m(){try{let e=await (0,i.Tt)("/auth/session"),t=r(null==e?void 0:e.role)?e.role:null;if((null==e?void 0:e.authenticated)&&t)return c(t),t;return o(),null}catch(e){return o(),null}}async function p(e,t){let a=await (0,i.B2)("/auth/login",{role:e,pin:t}),n=r(null==a?void 0:a.role)?a.role:null;if(!(null==a?void 0:a.authenticated)||!n)throw Error("Login failed.");return c(n),n}async function h(e){let t=!!(null==e?void 0:e.force),a="1"===window.sessionStorage.getItem(l);if(t||!a){window.sessionStorage.setItem(l,"1");try{await (0,i.B2)("/auth/logout",{})}finally{o()}}}async function u(){try{await (0,i.B2)("/auth/logout",{})}finally{o()}}},4872:(e,t,a)=>{Promise.resolve().then(a.bind(a,7562))},5695:(e,t,a)=>{"use strict";var i=a(8999);a.o(i,"useRouter")&&a.d(t,{useRouter:function(){return i.useRouter}})},5731:(e,t,a)=>{"use strict";a.d(t,{B2:()=>r,Tt:()=>l,pb:()=>c,zz:()=>o});var i=a(9509);let n=function(){var e;let t=(i.env.NEXT_PUBLIC_API_BASE_URL||"").trim();if(t)return t.replace(/\/+$/,"");if(null==(e=window.location)?void 0:e.origin){let{origin:e,hostname:t,port:a}=window.location;return("localhost"===t||"127.0.0.1"===t)&&"3000"===a?"http://".concat(t,":8080"):e}return"http://127.0.0.1:8080"}();async function s(e){if(!e.ok){let t="".concat(e.status," ").concat(e.statusText);try{let a=await e.json();(null==a?void 0:a.detail)&&(t=String(a.detail))}catch(e){}throw Error(t)}return await e.json()}async function l(e){return s(await fetch("".concat(n).concat(e),{cache:"no-store",credentials:"include"}))}async function r(e,t){return s(await fetch("".concat(n).concat(e),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),credentials:"include"}))}async function c(e,t){return s(await fetch("".concat(n).concat(e),{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),credentials:"include"}))}async function o(e,t){return s(await fetch("".concat(n).concat(e),{method:"POST",body:t,credentials:"include"}))}},7562:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>m});var i=a(5155),n=a(382),s=a(5731),l=a(6874),r=a.n(l),c=a(5695),o=a(2115),d=a(4860);function m(){let e=(0,c.useRouter)(),[t,a]=(0,o.useState)(""),[l,m]=(0,o.useState)(""),[p,h]=(0,o.useState)("Ready."),[u,f]=(0,o.useState)(""),[x,v]=(0,o.useTransition)(),[g,j]=(0,o.useState)(!1),[y,b]=(0,o.useState)([{role:"assistant",content:"CoPilot Symptomatologist web chat is ready. Ask about the current case or request a rewrite/summary."}]),[_,w]=(0,o.useState)(""),[N,k]=(0,o.useState)([]),[C,S]=(0,o.useState)([]),[D,P]=(0,o.useState)(""),[A,R]=(0,o.useState)([]),[F,T]=(0,o.useState)(""),[I,O]=(0,o.useState)(""),[B,L]=(0,o.useState)(""),[M,z]=(0,o.useState)([]),[q,E]=(0,o.useState)(""),[U,G]=(0,o.useState)(""),[H,K]=(0,o.useState)(""),[W,X]=(0,o.useState)(""),[Z,Q]=(0,o.useState)(!1),[Y,J]=(0,o.useState)(null),[V,$]=(0,o.useState)([]),[ee,et]=(0,o.useState)([]),[ea,ei]=(0,o.useState)(!1),[en,es]=(0,o.useState)(""),[el,er]=(0,o.useState)(""),[ec,eo]=(0,o.useState)(""),[ed,em]=(0,o.useState)(""),[ep,eh]=(0,o.useState)(""),[eu,ef]=(0,o.useState)(()=>new Date().toISOString().slice(0,10)),[ex,ev]=(0,o.useState)("09:00"),[eg,ej]=(0,o.useState)(30),[ey,eb]=(0,o.useState)(!0),[e_,ew]=(0,o.useState)(!1),[eN,ek]=(0,o.useState)(""),[eC,eS]=(0,o.useState)(!1),[eD,eP]=(0,o.useState)(!1),[eA,eR]=(0,o.useState)([]),[eF,eT]=(0,o.useState)(null),eI=(0,o.useRef)(null);(0,o.useEffect)(()=>{let t=!1;return(async()=>{if(await (0,d.je)(),t)return;let a=await (0,d.b0)();if(!t){if("assistant"===a)return e.replace("/assistant/?notice=doctor_locked");if("doctor"!==a)return e.replace("/login/?next=doctor");j(!0)}})(),()=>{t=!0}},[e]);let eO=(e,t)=>{f(e instanceof Error?e.message:t)},eB=e=>{try{return new Date(e).toLocaleString()}catch(t){return e}},eL=e=>{let t=(e||"").match(/(?:Date of Birth|DOB)\s*:\s*([^\n\r]+)/i);return((null==t?void 0:t[1])||"").trim()},eM=e=>{let t=(e||"").match(/(?:Full Name|Patient Name)\s*:\s*([^\n\r]+)/i);if(((null==t?void 0:t[1])||"").trim())return(null==t?void 0:t[1].trim())||"";let a=(e||"").match(/\[Assistant intake selected\]\s*([^\n\r]+)/i);return((null==a?void 0:a[1])||"").trim()},ez=(e,t)=>{for(let a of(e||"").replace(/\r/g,"\n").split("\n")){let e=(a||"").trim();if(!e)continue;let i=e.toLowerCase();for(let a of t){let t=(a||"").trim().toLowerCase();if(t&&i.startsWith(t))return e.slice(t.length).trim()}}return""},eq=e=>{let t=(e||"").trim();if(!t)return"";let a=new Date(t);if(Number.isNaN(a.getTime()))return"";let i=new Date,n=i.getFullYear()-a.getFullYear(),s=new Date(i.getFullYear(),a.getMonth(),a.getDate());return i<s&&(n-=1),n>=0?String(n):""},eE=e=>{let t=en.trim()||eM(e)||"________________",a=eL(e),i=ez(e,["Age:","Age/Gender:"]),n=ez(e,["Gender:","Sex:"]),s=eq(a),l=ez(e,["Address:"]),r=ep.trim()||ez(e,["Follow up:","Follow-up:"]),c=(eu||"").trim()||new Date().toISOString().slice(0,10),o="";return o=i&&n?"".concat(i," / ").concat(n):i||(s&&n?"".concat(s," / ").concat(n):s||n),{note:["DOCTOR TEMPLATE","Physician: RICHELLE JOY DIAMANTE-BAYSON, MD, FPCP, FPRA","Specialty: Internal Medicine (Adult Diseases Specialist), Rheumatology, Clinical Immunology & Osteoporosis","","Patient Name: ".concat(t),"Age/Gender: ".concat(o||"________________"),"Address: ".concat(l||"________________"),"Date: ".concat(c),"","RX / Clinical Orders:",e.trim()||"(No clinical note provided.)","","Follow up on:",r||"As advised by attending physician.","","Signature:","Richelle Joy D. Bayson, MD","Lic. No.: 0114277","PTR No.: 9234542"].join("\n"),patientName:t.trim(),patientDob:a.trim()}},eU=e=>{let t=eL(e),a=ez(e,["Gender:","Sex:"]).trim(),i=ez(e,["Address:"]).trim(),n=ez(e,["Age:","Age/Gender:"]).trim(),s=eq(t),l=n||s,r=ez(e,["Age/Gender:"]).trim();return r||(r=l&&a?"".concat(l," / ").concat(a):l||a),{patient_dob:t,patient_gender:a,patient_address:i,patient_age:l,patient_age_gender:r,requested_for:ed.trim()||"clinic documentation"}},eG=async()=>{ei(!0),f(""),h("Loading scheduling data...");try{var e,t;let[a,i,n]=await Promise.all([(0,s.Tt)("/availability"),(0,s.Tt)("/appointments"),(0,s.Tt)("/waitlist")]);J(a),$(null!=(e=i.items)?e:[]),et(null!=(t=n.items)?t:[]),h("Scheduling data loaded.")}catch(e){eO(e,"Failed to load scheduling data.")}finally{ei(!1)}},eH=async()=>{if(Y){ei(!0),f(""),h("Saving availability...");try{let e=await (0,s.B2)("/availability",Y);J(e.availability),h("Availability saved.")}catch(e){eO(e,"Failed to save availability.")}finally{ei(!1)}}},eK=async()=>{let e=en.trim();if(!e)return void f("Patient name is required.");let t=new Date("".concat(eu,"T").concat(ex)).toISOString();ei(!0),f(""),h("Creating appointment...");try{let i=await (0,s.B2)("/appointments",{patient_name:e,patient_email:el.trim(),patient_phone:ec.trim(),reason:ed.trim(),notes:ep.trim(),start_time:t,duration_minutes:eg,allow_waitlist:ey});if(i.waitlisted)h("Time slot was full; patient added to waitlist.");else{var a;h("Appointment created".concat((null==(a=i.appointment)?void 0:a.id)?" (".concat(i.appointment.id,")"):"","."))}await eG()}catch(e){eO(e,"Failed to create appointment.")}finally{ei(!1)}},eW=async(e,t)=>{ei(!0),f(""),h("Updating appointment ".concat(e,"..."));try{await (0,s.pb)("/appointments/".concat(e),{status:t}),h("Appointment updated: ".concat(e,".")),await eG()}catch(e){eO(e,"Failed to update appointment.")}finally{ei(!1)}},eX=async e=>{ei(!0),f(""),h("Sending reminder for ".concat(e,"..."));try{await (0,s.B2)("/appointments/".concat(e,"/send_reminder"),{}),h("Reminder sent."),await eG()}catch(e){eO(e,"Failed to send reminder.")}finally{ei(!1)}},eZ=async e=>{var t,a;if(!(null==e?void 0:e.id))return;if((null!=(t=e.status)?t:"waiting")!=="waiting")return void f("Only waiting items can be converted.");let i=(null!=(a=e.preferred_start_time)?a:"").trim();if(!i)return void f("This waitlist item has no preferred start time.");ei(!0),f(""),h("Converting waitlist item ".concat(e.id,"..."));try{await (0,s.B2)("/waitlist/".concat(e.id,"/convert"),{start_time:i}),h("Waitlist item converted: ".concat(e.id,".")),await eG()}catch(e){eO(e,"Failed to convert waitlist item.")}finally{ei(!1)}},eQ=e=>{a(t=>"".concat(t).concat(t.trim()?"\n\n":"").concat(e).trim())},eY=e=>{let t=(e||"").trim();return t?t.startsWith("/")?t:"/storage/".concat(t.replace(/^\/+/,"")):""},eJ=(e,t)=>{let a=eY(e);a&&eT({url:a,title:t||"Patient document"})},eV=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Patient document";eJ(e,t)},e$=e=>'"'.concat((e||"").replace(/"/g,'""'),'"'),e0=async()=>{try{var e;let t=(null!=(e=(await (0,s.Tt)("/documents/pdfs")).items)?e:[]).map(e=>{let t=(e.path||"").replace(/^\/+/,"");return{id:e.id||t,document_type:e.document_type||"document",title:e.title||e.filename||"Document",patient_name:e.patient_name||"",patient_dob:e.patient_dob||"",filename:e.filename||t,path:t,stored_path:eY(e.stored_path||t),created_at:e.created_at||"",size_bytes:e.size_bytes}});eR(t)}catch(e){}},e1=async e=>{var t;let a=M.filter(e=>{var t;return(null!=(t=e.tags)?t:[]).every(e=>"patient-record"!==e)}).slice(0,5).map(e=>e.filename);return null!=(t=(await (0,s.B2)("/analyze_case",{note:e,reference_names:a})).analysis)?t:""},e2=e=>{var t;let a=e.intake,i=(null==(t=e.meta)?void 0:t.full_name)||(null==a?void 0:a.FullName)||"Unknown patient",n=["[Assistant intake selected] ".concat(i)];return(null==a?void 0:a.DateOfBirth)&&n.push("DOB: ".concat(a.DateOfBirth)),(null==a?void 0:a.ChiefComplaint)&&n.push("Chief complaint: ".concat(a.ChiefComplaint)),(e.intake_summary||"").trim()&&n.push("Intake summary:\n".concat((e.intake_summary||"").trim())),(e.enhanced_report||"").trim()&&n.push("Enhanced report:\n".concat((e.enhanced_report||"").trim())),{name:i,noteText:n.join("\n\n")}},e5=async e=>{var t,a;if(!e.intake)return null;let{name:i}=e2(e),n=await (0,s.B2)("/documents/intake_pdf",{intake:e.intake,enhanced_report:null!=(a=e.enhanced_report)?a:"",title:"Assistant Intake Record - ".concat(i)});return(null==(t=n.document)?void 0:t.stored_path)?n.document:null},e8=async()=>{f(""),h("Loading doctor records and assistant intakes...");try{var e,t,a,i,n,l;let[r,c,o]=await Promise.all([(0,s.Tt)("/patient_records"),(0,s.Tt)("/intakes"),(0,s.Tt)("/documents/pdfs")]),d=null!=(t=r.items)?t:[],m=null!=(a=c.items)?a:[],p=(null!=(i=o.items)?i:[]).map(e=>{let t=(e.path||"").replace(/^\/+/,"");return{id:e.id||t,document_type:e.document_type||"document",title:e.title||e.filename||"Document",patient_name:e.patient_name||"",patient_dob:e.patient_dob||"",filename:e.filename||t,path:t,stored_path:eY(e.stored_path||t),created_at:e.created_at||"",size_bytes:e.size_bytes}});k(d),S(m),eR(p),!eN&&(null==(e=m[0])?void 0:e.id)?ek(m[0].id):eN&&!m.some(e=>e.id===eN)&&ek(null!=(l=null==(n=m[0])?void 0:n.id)?l:""),h(["Loaded ".concat(d.length," doctor record(s)"),"".concat(m.length," assistant intake(s)"),"".concat(p.length," generated document(s).")].join(", "))}catch(e){eO(e,"Failed to load patient records.")}},e3=async e=>{f(""),h("Loading assistant intake ".concat(e,"..."));try{let t=await (0,s.Tt)("/intakes/".concat(e));eQ(e2(t).noteText),h("Assistant intake ".concat(e," appended to doctor note."))}catch(e){eO(e,"Failed to load assistant intake.")}},e4=e=>{f(""),h("Opening assistant intake ".concat(e,"...")),v(async()=>{try{let t=await (0,s.Tt)("/intakes/".concat(e)),{name:i,noteText:n}=e2(t);a(n),es(e=>e||i);let l=!1;if(t.intake)try{let e=await e5(t);(null==e?void 0:e.stored_path)&&(eV(e.stored_path,e.filename||"Assistant Intake Record - ".concat(i)),l=!0,await e0())}catch(e){l=!1}let r=await e1(n);m(r),h(l?"Loaded ".concat(i,", opened patient PDF, and completed AI analysis."):"Loaded ".concat(i," and completed AI analysis."))}catch(e){eO(e,"Failed to open assistant intake for analysis.")}})},e6=e=>{f(""),h("Preparing intake PDF for ".concat(e,"...")),v(async()=>{try{let t=await (0,s.Tt)("/intakes/".concat(e)),a=await e5(t);if(!(null==a?void 0:a.stored_path))return void f("Could not generate intake PDF for this record.");eV(a.stored_path,a.filename||"Assistant Intake Record"),h("Opened intake PDF: ".concat(a.filename)),await e0()}catch(e){eO(e,"Failed to open intake PDF.")}})},e7=async()=>{let e=!e_;ew(e),e&&(C.length||await e8())},e9=async()=>{f(""),h("Loading local references / KB...");try{var e,t,a,i;let n=await (0,s.Tt)("/train_ai/status");z(null!=(a=n.documents)?a:[]),!q&&(null==(t=n.documents)||null==(e=t[0])?void 0:e.filename)&&E(n.documents[0].filename),h("Loaded ".concat(null!=(i=n.trained_documents)?i:0," trained document(s)."))}catch(e){eO(e,"Failed to load KB status.")}},te=async e=>{f(""),h("Extracting attachment: ".concat(e.name));try{var t;let a=new FormData;a.append("file",e);let i=await (0,s.zz)("/attachments/extract",a),n=["[Attachment: ".concat(e.name,"]"),(null==(t=i.extracted_text)?void 0:t.trim())?i.extracted_text.trim():i.message||"No text extracted."].join("\n");eQ(n),h("Attachment processed: ".concat(e.name))}catch(e){eO(e,"Attachment processing failed.")}},tt=async e=>{f(""),h("Parsing handwritten RX: ".concat(e.name));try{var a,i;let n=new FormData;n.append("file",e);let l=en.trim()||eM(t),r=eL(t);l&&n.append("patient_name",l),r&&n.append("patient_dob",r);let c=await (0,s.zz)("/attachments/extract",n),o=(null==(a=c.extracted_text)?void 0:a.trim())?c.extracted_text.trim():c.message||"No readable text detected from handwritten RX.";eQ("[Handwritten RX: ".concat(e.name,"]\n").concat(o)),(null==(i=c.extracted_text)?void 0:i.trim())?h("Handwritten RX parsed and added to Doctor Note: ".concat(e.name)):h("Handwritten RX uploaded, but OCR found limited/no text: ".concat(e.name))}catch(e){eO(e,"Handwritten RX processing failed.")}},ta=()=>{let e=_.trim();if(!e)return;f(""),h("Sending chat message...");let t=[...y,{role:"user",content:e}];b(t),w(""),v(async()=>{try{let e=await (0,s.B2)("/chat",{history:t});b(t=>{var a;return[...t,{role:"assistant",content:null!=(a=e.reply)?a:"No response."}]}),h("Chat reply received.")}catch(e){eO(e,"Chat failed.")}})},ti=async e=>{if(null==e?void 0:e.length){Q(!0),f(""),h("Training on ".concat(e.length," file(s)..."));try{for(let t of Array.from(e)){let e=new FormData;e.append("file",t),W.trim()&&e.append("tags",W.trim()),await (0,s.zz)("/train_ai/upload",e)}h("Training upload complete (".concat(e.length," file(s)).")),await e9()}catch(e){eO(e,"Train AI upload failed.")}finally{Q(!1)}}};if(!g)return(0,i.jsx)("main",{className:"shell",children:(0,i.jsx)("section",{className:"panel",children:(0,i.jsx)("p",{className:"small-meta",children:"Checking access..."})})});let tn=eA.filter(e=>(e.filename||e.path||"").trim().toLowerCase().endsWith(".pdf"));return(0,i.jsxs)("main",{className:"shell stack","data-testid":"doctor-page",children:[(0,i.jsxs)("section",{className:"hero",children:[(0,i.jsx)("h1",{className:"doctor-hero-title",children:"Medical Doctor Workspace"}),(0,i.jsx)("p",{children:"Clinical command center for physicians: review assistant intakes, perform AI-supported case analysis, manage scheduling, generate patient documents, and maintain complete patient records for final doctor-reviewed decisions."}),(0,i.jsxs)("nav",{className:"hero-nav",children:[(0,i.jsx)(r(),{href:"/",children:"Home"}),(0,i.jsx)(r(),{href:"/assistant",children:"Assistant Portal"}),(0,i.jsx)("button",{className:"nav-chip-btn",type:"button","data-testid":"doctor-logout",onClick:()=>{f(""),h("Signing out..."),v(async()=>{try{await (0,d.XN)()}finally{e.replace("/login/?fresh=1")}})},disabled:x,children:"Logout"}),(0,i.jsx)("button",{className:"nav-chip-btn","data-testid":"doctor-refresh-kb",onClick:()=>void e9(),children:"Refresh KB"}),(0,i.jsx)("button",{className:"nav-chip-btn","data-testid":"doctor-refresh-patient-records",onClick:()=>void e8(),children:"Refresh patient/intake records"})]})]}),(0,i.jsx)(n.Z,{title:"Scheduling",subtitle:"Appointments, availability, waitlist, reminders",children:(0,i.jsxs)("div",{className:"stack",style:{gap:12},children:[(0,i.jsxs)("div",{className:"hero-nav",style:{alignItems:"center"},children:[(0,i.jsx)("button",{className:"btn ghost",onClick:()=>void eG(),disabled:ea,children:ea?"Loading...":"Refresh scheduling"}),(0,i.jsxs)(n.r,{children:["API: ",(0,i.jsx)("code",{children:"/appointments"}),", ",(0,i.jsx)("code",{children:"/availability"}),", ",(0,i.jsx)("code",{children:"/waitlist"})]})]}),(0,i.jsxs)("div",{className:"page-grid columns-2",children:[(0,i.jsxs)("div",{className:"stack",style:{gap:12},children:[(0,i.jsxs)("div",{className:"field-grid",children:[(0,i.jsxs)("div",{className:"field",children:[(0,i.jsx)("label",{children:"Patient name"}),(0,i.jsx)("input",{value:en,onChange:e=>es(e.target.value)})]}),(0,i.jsxs)("div",{className:"field",children:[(0,i.jsx)("label",{children:"Patient email (for reminders)"}),(0,i.jsx)("input",{value:el,onChange:e=>er(e.target.value)})]}),(0,i.jsxs)("div",{className:"field",children:[(0,i.jsx)("label",{children:"Patient phone"}),(0,i.jsx)("input",{value:ec,onChange:e=>eo(e.target.value)})]}),(0,i.jsxs)("div",{className:"field",children:[(0,i.jsx)("label",{children:"Reason"}),(0,i.jsx)("input",{value:ed,onChange:e=>em(e.target.value)})]}),(0,i.jsxs)("div",{className:"field",children:[(0,i.jsx)("label",{children:"Date"}),(0,i.jsx)("input",{type:"date",value:eu,onChange:e=>ef(e.target.value)})]}),(0,i.jsxs)("div",{className:"field",children:[(0,i.jsx)("label",{children:"Time"}),(0,i.jsx)("input",{type:"time",value:ex,onChange:e=>ev(e.target.value)})]}),(0,i.jsxs)("div",{className:"field",children:[(0,i.jsx)("label",{children:"Duration (minutes)"}),(0,i.jsx)("select",{value:eg,onChange:e=>ej(Number(e.target.value)),children:[15,30,45,60].map(e=>(0,i.jsx)("option",{value:e,children:e},e))})]}),(0,i.jsx)("div",{className:"field",children:(0,i.jsxs)("label",{style:{display:"flex",alignItems:"center",gap:8},children:[(0,i.jsx)("input",{type:"checkbox",checked:ey,onChange:e=>eb(e.target.checked)}),"Add to waitlist if slot is full"]})})]}),(0,i.jsxs)("div",{className:"field",children:[(0,i.jsx)("label",{children:"Notes"}),(0,i.jsx)("textarea",{value:ep,onChange:e=>eh(e.target.value)})]}),(0,i.jsx)("div",{className:"hero-nav",children:(0,i.jsx)("button",{className:"btn",onClick:()=>void eK(),disabled:ea,children:"Create appointment"})})]}),(0,i.jsx)("div",{className:"stack",style:{gap:12},children:(0,i.jsxs)("div",{className:"field",children:[(0,i.jsx)("label",{children:"Availability (weekly)"}),Y?(0,i.jsxs)("div",{className:"stack",style:{gap:10},children:[(0,i.jsxs)("div",{className:"field",style:{maxWidth:220},children:[(0,i.jsx)("label",{children:"Slot minutes"}),(0,i.jsx)("input",{type:"number",value:Y.slot_minutes,onChange:e=>J({...Y,slot_minutes:Number(e.target.value||15)})})]}),Y.windows.map((e,t)=>(0,i.jsxs)("div",{className:"field-grid compact-3",children:[(0,i.jsxs)("div",{className:"field",children:[(0,i.jsx)("label",{children:"Weekday (0=Mon..6=Sun)"}),(0,i.jsx)("input",{type:"number",value:e.weekday,onChange:a=>{let i=Y.windows.slice();i[t]={...e,weekday:Number(a.target.value)},J({...Y,windows:i})}})]}),(0,i.jsxs)("div",{className:"field",children:[(0,i.jsx)("label",{children:"Start"}),(0,i.jsx)("input",{type:"time",value:e.start,onChange:a=>{let i=Y.windows.slice();i[t]={...e,start:a.target.value},J({...Y,windows:i})}})]}),(0,i.jsxs)("div",{className:"field",children:[(0,i.jsx)("label",{children:"End"}),(0,i.jsx)("input",{type:"time",value:e.end,onChange:a=>{let i=Y.windows.slice();i[t]={...e,end:a.target.value},J({...Y,windows:i})}})]})]},"".concat(e.weekday,"-").concat(t))),(0,i.jsx)("div",{className:"hero-nav",children:(0,i.jsx)("button",{className:"btn",onClick:()=>void eH(),disabled:ea,children:"Save availability"})})]}):(0,i.jsx)(n.r,{children:"Click “Refresh scheduling” to load availability."})]})})]}),(0,i.jsxs)("div",{className:"page-grid columns-2",children:[(0,i.jsxs)("div",{className:"stack",style:{gap:10},children:[(0,i.jsx)("h3",{style:{margin:0},children:"Upcoming appointments"}),V.length?(0,i.jsx)("div",{className:"stack",style:{gap:10},children:V.slice(0,12).map(e=>(0,i.jsxs)("div",{className:"panel",style:{padding:12},children:[(0,i.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",gap:12},children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("strong",{children:e.patient_name}),(0,i.jsx)("div",{className:"small-meta",children:eB(e.start_time)}),(0,i.jsxs)("div",{className:"small-meta",children:["Status: ",e.status]})]}),(0,i.jsxs)("div",{className:"hero-nav",style:{justifyContent:"flex-end"},children:[(0,i.jsx)("button",{className:"btn ghost",onClick:()=>void eW(e.id,"checked_in"),children:"Check-in"}),(0,i.jsx)("button",{className:"btn ghost",onClick:()=>void eW(e.id,"completed"),children:"Complete"}),(0,i.jsx)("button",{className:"btn ghost",onClick:()=>void eW(e.id,"cancelled"),children:"Cancel"}),(0,i.jsx)("button",{className:"btn ghost",onClick:()=>void eX(e.id),children:"Send reminder"})]})]}),e.reason?(0,i.jsxs)("div",{className:"small-meta",children:["Reason: ",e.reason]}):null,e.patient_email?(0,i.jsxs)("div",{className:"small-meta",children:["Email: ",e.patient_email]}):null]},e.id))}):(0,i.jsx)(n.r,{children:"No appointments loaded."})]}),(0,i.jsxs)("div",{className:"stack",style:{gap:10},children:[(0,i.jsx)("h3",{style:{margin:0},children:"Waitlist"}),ee.length?(0,i.jsx)("div",{className:"stack",style:{gap:10},children:ee.slice(0,12).map(e=>{var t;return(0,i.jsxs)("div",{className:"panel",style:{padding:12},children:[(0,i.jsx)("strong",{children:e.patient_name}),(0,i.jsxs)("div",{className:"small-meta",children:["Status: ",e.status]}),e.preferred_start_time?(0,i.jsxs)("div",{className:"small-meta",children:["Preferred: ",eB(e.preferred_start_time)]}):null,e.reason?(0,i.jsxs)("div",{className:"small-meta",children:["Reason: ",e.reason]}):null,(0,i.jsx)("div",{className:"hero-nav",style:{justifyContent:"flex-start"},children:(0,i.jsx)("button",{className:"btn ghost",onClick:()=>void eZ(e),disabled:ea||(null!=(t=e.status)?t:"waiting")!=="waiting"||!e.preferred_start_time,children:"Convert to appointment"})})]},e.id)})}):(0,i.jsx)(n.r,{children:"No waitlist items."})]})]})]})}),(0,i.jsx)("div",{className:"status".concat(u?" error":""),"data-testid":"doctor-status",children:u||p}),(0,i.jsxs)("div",{className:"page-grid columns-2",children:[(0,i.jsxs)(n.Z,{title:"Doctor Note",subtitle:"Follow steps below to complete a doctor-reviewed case",children:[(0,i.jsxs)("div",{className:"panel",style:{padding:12},children:[(0,i.jsx)("strong",{children:"Recommended flow"}),(0,i.jsxs)("ol",{className:"workflow-steps",children:[(0,i.jsx)("li",{children:"Load assistant patient record first, then review the drafted note."}),(0,i.jsx)("li",{children:"Run case analysis and revise wording if needed."}),(0,i.jsx)("li",{children:"Save patient record to host storage."}),(0,i.jsx)("li",{children:"Generate final PDFs for patient record and certificate."})]}),(0,i.jsxs)("div",{style:{marginTop:10},children:[(0,i.jsxs)("label",{style:{display:"inline-flex",alignItems:"center",gap:8,fontWeight:600},children:[(0,i.jsx)("input",{type:"checkbox","data-testid":"doctor-template-toggle",checked:eC,onChange:e=>eS(e.target.checked)}),"Allow Doctor's Template for Patient Record PDF"]}),(0,i.jsx)(n.r,{children:"If enabled, the Doctor Note content is wrapped in your prescription-style template before generating the patient-record PDF."})]}),(0,i.jsxs)("div",{style:{marginTop:10},children:[(0,i.jsxs)("label",{style:{display:"inline-flex",alignItems:"center",gap:8,fontWeight:600},children:[(0,i.jsx)("input",{type:"checkbox","data-testid":"doctor-medcert-template-toggle",checked:eD,onChange:e=>eP(e.target.checked)}),"Allow Doctor's Template for Medical Certificate PDF"]}),(0,i.jsx)(n.r,{children:"If enabled, Medical Certificate PDF follows the template layout with fixed clinic header and certificate body format."})]})]}),(0,i.jsxs)("div",{className:"action-help-grid",style:{marginTop:10},children:[(0,i.jsxs)("div",{className:"action-help-item",children:[(0,i.jsx)("button",{className:"btn primary","data-testid":"doctor-attach-file-label",onClick:()=>void e7(),children:"1) Attach assistant patient record"}),(0,i.jsx)(n.r,{children:"Start here. Select the patient created by assistant so Doctor Note can be prefilled."})]}),(0,i.jsxs)("div",{className:"action-help-item",children:[(0,i.jsxs)("label",{className:"btn accent action-help-upload","data-testid":"doctor-upload-local-file-label",children:["Upload local file (PDF/Text/Image)",(0,i.jsx)("input",{hidden:!0,type:"file","data-testid":"doctor-attach-file-input",onChange:e=>{var t;let a=null==(t=e.target.files)?void 0:t[0];a&&te(a),e.currentTarget.value=""}})]}),(0,i.jsx)(n.r,{children:"Optional. Add extra doctor documents/lab files to append text into Doctor Note."})]}),(0,i.jsxs)("div",{className:"action-help-item",children:[(0,i.jsx)("button",{className:"btn primary","data-testid":"doctor-analyze-case",disabled:x,onClick:()=>{f(""),h("Analyzing case..."),v(async()=>{try{let e=await e1(t);m(e),h("Case analysis complete.")}catch(e){eO(e,"Analyze failed.")}})},children:"2) Analyze Case"}),(0,i.jsx)(n.r,{children:"Generates AI clinical support output on the right panel for doctor review."})]}),(0,i.jsxs)("div",{className:"action-help-item",children:[(0,i.jsx)("button",{className:"btn accent","data-testid":"doctor-revise-report",disabled:x,onClick:()=>{f(""),h("Revising medical report..."),v(async()=>{try{var e;let i=await (0,s.B2)("/chat",{history:[{role:"system",content:"You are an expert medical scribe. Rewrite the doctor's note as a formal structured medical report. Keep every fact and measurement. Do not omit or invent information. If uncertain, preserve the original wording."},{role:"user",content:t}]});a(null!=(e=i.reply)?e:t),h("Doctor note revised.")}catch(e){eO(e,"Revision failed.")}})},children:"Revise Report"}),(0,i.jsx)(n.r,{children:"Optional rewrite. Improves structure of Doctor Note while keeping original facts."})]}),(0,i.jsxs)("div",{className:"action-help-item",children:[(0,i.jsx)("button",{className:"btn primary","data-testid":"doctor-save-patient-record",disabled:x,onClick:()=>{f(""),h("Saving patient record..."),v(async()=>{try{var e,a;let i=await (0,s.B2)("/patient_records",{note:t});h("Patient record saved: ".concat(null!=(a=null==(e=i.record)?void 0:e.filename)?a:"")),await e8(),await e9()}catch(e){eO(e,"Save patient record failed.")}})},children:"3) Save Patient Record"}),(0,i.jsx)(n.r,{children:"Persists this doctor note to host storage for future retrieval and audit trail."})]}),(0,i.jsxs)("div",{className:"action-help-item",children:[(0,i.jsx)("button",{className:"btn accent","data-testid":"doctor-generate-patient-pdf",disabled:x,onClick:()=>{let e=t.trim();if(!e)return void f("Doctor note is empty.");f(""),h("Generating patient record PDF..."),v(async()=>{try{let t=(en.trim()||eM(e)).trim(),a=eL(e),i=eC?eE(e):null,n=(null==i?void 0:i.note)||e,l=(null==i?void 0:i.patientName)||t,r=(null==i?void 0:i.patientDob)||a,c=await (0,s.B2)("/documents/patient_record_pdf",{note:n,title:eC?"Doctor Patient Record (Template)":"Doctor Patient Record",patient_name:l,patient_dob:r,source_role:"doctor"});h("".concat(eC?"Template-applied ":"","patient record PDF ready: ").concat(c.document.filename)),eV(c.document.stored_path,c.document.filename||"Patient Record PDF"),await e0()}catch(e){eO(e,"Failed to generate patient record PDF.")}})},children:"4) Generate Patient Record PDF"}),(0,i.jsx)(n.r,{children:"Exports the finalized patient case record to PDF for sharing/printing."})]}),(0,i.jsxs)("div",{className:"action-help-item",children:[(0,i.jsx)("button",{className:"btn primary","data-testid":"doctor-generate-certificate-pdf",disabled:x,onClick:()=>{var e,a,i,n,l;let r=en.trim(),c=(window.prompt("Patient name",r)||"").trim();if(!c)return void f("Patient name is required to generate a medical certificate.");let o=null!=(e=window.prompt("Diagnosis / impression",ed||""))?e:"",d=null!=(a=window.prompt("Recommendations","Patient is advised to follow up and rest as needed."))?a:"",m=eL(t),p=(window.prompt("Date of birth (optional)",m)||"").trim(),u=window.prompt("Rest days (optional integer)","1"),x=null!=(i=window.prompt("Doctor name",""))?i:"",g=null!=(n=window.prompt("Doctor license (optional)",""))?n:"",j=null!=(l=window.prompt("Clinic / facility name",""))?l:"",y=u&&/^\d+$/.test(u.trim())?Number(u.trim()):null,b=eU(t);f(""),h("Generating medical certificate PDF..."),v(async()=>{try{let e=await (0,s.B2)("/documents/medical_certificate_pdf",{patient_name:c,patient_dob:p,diagnosis:o,recommendations:d,rest_days:y,doctor_name:x,doctor_license:g,clinic_name:j,additional_notes:t.slice(0,1200),patient_address:b.patient_address,patient_gender:b.patient_gender,patient_age:b.patient_age,patient_age_gender:b.patient_age_gender,requested_for:b.requested_for,use_doctor_template:eD,certificate_title:eD?"Medical Certificate (Doctor Template)":"Medical Certificate"});h("".concat(eD?"Template-applied ":"","medical certificate PDF ready: ").concat(e.document.filename)),eV(e.document.stored_path,e.document.filename||"Medical Certificate PDF"),await e0()}catch(e){eO(e,"Failed to generate medical certificate PDF.")}})},children:"Generate Medical Certificate PDF"}),(0,i.jsx)(n.r,{children:"Optional. Creates medical certificate PDF after diagnosis/recommendation inputs."})]}),(0,i.jsxs)("div",{className:"action-help-item",children:[(0,i.jsx)("button",{className:"btn danger","data-testid":"doctor-clear-note",onClick:()=>a(""),children:"Clear"}),(0,i.jsx)(n.r,{children:"Resets Doctor Note text area for a new case draft."})]})]}),(0,i.jsxs)("div",{className:"panel stack",style:{marginTop:12,padding:12,gap:8},"data-testid":"doctor-quick-pdf-card",children:[(0,i.jsx)("strong",{children:"Patient Record Files"}),(0,i.jsx)(n.r,{children:"After saving a patient record, select a file below to open PDF reader popup (view or print)."}),(0,i.jsxs)("div",{className:"toolbar",children:[(0,i.jsx)("button",{className:"btn","data-testid":"doctor-refresh-quick-pdf-list",onClick:()=>void e8(),children:"Refresh file list"}),(0,i.jsx)("button",{className:"btn accent","data-testid":"doctor-generate-census",onClick:()=>{let e=[];for(let t of(e.push("source,record_id,patient_name,date_of_birth,chief_complaint,created_at,filename"),C))e.push(["assistant_intake",e$(t.id||""),e$(t.full_name||""),e$(t.date_of_birth||""),e$(t.chief_complaint||""),e$(t.created_at||""),e$("")].join(","));for(let t of N){let a=(t.filename||"").match(/^(.+?) \((.+?)\)/),i=((null==a?void 0:a[1])||"").trim(),n=((null==a?void 0:a[2])||"").trim();e.push(["doctor_record",e$(t.id||""),e$(i||t.title||""),e$(n),e$(""),e$(t.created_at||""),e$(t.filename||"")].join(","))}let t=new Date().toISOString().replace(/[:]/g,"-"),a=new Blob([e.join("\n")],{type:"text/csv;charset=utf-8"}),i=URL.createObjectURL(a),n=document.createElement("a");n.href=i,n.download="patient_census_".concat(t,".csv"),n.click(),URL.revokeObjectURL(i),h("Census generated: ".concat(C.length," assistant intake(s), ").concat(N.length," doctor record(s)."))},children:"Generate Census"})]}),(0,i.jsx)("div",{className:"list scroll-list","data-testid":"doctor-quick-pdf-list",children:0===tn.length?(0,i.jsx)("div",{className:"list-item",children:(0,i.jsx)(n.r,{children:"No PDF patient files available yet."})}):tn.map(e=>(0,i.jsxs)("div",{className:"list-item","data-testid":"doctor-quick-pdf-item",children:[(0,i.jsx)("strong",{children:e.patient_name||"(Unnamed patient)"}),(0,i.jsx)(n.r,{children:e.filename}),(0,i.jsxs)(n.r,{children:["Type: ",e.document_type||"document"," | Created: ",e.created_at||"-"]}),(0,i.jsx)("button",{className:"btn primary","data-testid":"doctor-open-quick-pdf-".concat(e.id),onClick:()=>eV(e.stored_path,e.filename||e.title||"Patient document"),children:"Open PDF (View/Print)"})]},"quick-".concat(e.id)))})]}),e_?(0,i.jsxs)("div",{className:"panel stack",style:{marginTop:12,padding:12,gap:10},"data-testid":"doctor-assistant-intake-picker",children:[(0,i.jsxs)("div",{className:"field",children:[(0,i.jsx)("label",{htmlFor:"assistantIntakeSelect",children:"Assistant patient intake"}),(0,i.jsxs)("select",{id:"assistantIntakeSelect","data-testid":"doctor-assistant-intake-select",value:eN,onChange:e=>ek(e.target.value),children:[(0,i.jsx)("option",{value:"",children:"Select assistant patient record..."}),C.map(e=>(0,i.jsxs)("option",{value:e.id,children:[e.full_name||"(Unnamed patient)"," | DOB: ",e.date_of_birth||"-"," |"," ",e.created_at]},e.id))]})]}),(0,i.jsxs)("div",{className:"action-help-grid",children:[(0,i.jsxs)("div",{className:"action-help-item",children:[(0,i.jsx)("button",{className:"btn primary","data-testid":"doctor-open-selected-intake",disabled:x||!eN,onClick:()=>e4(eN),children:"Open Selected Patient + Analyze"}),(0,i.jsx)(n.r,{children:"Loads intake into Doctor Note, opens patient PDF, then runs AI analysis."})]}),(0,i.jsxs)("div",{className:"action-help-item",children:[(0,i.jsx)("button",{className:"btn","data-testid":"doctor-refresh-intake-picker",disabled:x,onClick:()=>void e8(),children:"Refresh patient records"}),(0,i.jsx)(n.r,{children:"Use this if newly saved assistant records are not yet listed."})]})]}),(0,i.jsx)(n.r,{children:"Selecting a patient loads the assistant intake into Doctor Note, opens a patient PDF, and runs AI Analysis for doctor review."})]}):null,(0,i.jsx)("textarea",{"data-testid":"doctor-note",value:t,onChange:e=>a(e.target.value),placeholder:"Paste or dictate doctor note here...",style:{minHeight:360,marginTop:12}}),(0,i.jsxs)("div",{className:"panel stack",style:{marginTop:12,padding:12,gap:8},children:[(0,i.jsx)("strong",{children:"Prescription (RX) attachment"}),(0,i.jsx)("div",{className:"action-help-grid",children:(0,i.jsxs)("div",{className:"action-help-item",children:[(0,i.jsxs)("label",{className:"btn accent action-help-upload","data-testid":"doctor-attach-rx-label",children:["Attach Handwritten RX (Image/PDF)",(0,i.jsx)("input",{hidden:!0,type:"file",accept:"image/*,.pdf,application/pdf","data-testid":"doctor-attach-rx-input",onChange:e=>{var t;let a=null==(t=e.target.files)?void 0:t[0];a&&tt(a),e.currentTarget.value=""}})]}),(0,i.jsx)(n.r,{children:"Upload doctor handwritten RX and the system will OCR-parse it into text, then append it to Doctor Note so it is saved with the patient record."})]})})]}),(0,i.jsxs)("div",{className:"panel stack",style:{marginTop:12,padding:12,gap:8},children:[(0,i.jsx)("strong",{children:"Final step: AI certificate output"}),(0,i.jsx)("div",{className:"action-help-grid",children:(0,i.jsxs)("div",{className:"action-help-item",children:[(0,i.jsx)("button",{className:"btn accent","data-testid":"doctor-generate-certificate-ai-bottom",disabled:x,onClick:()=>{let e=t.trim();if(!e)return void f("Doctor note is empty.");let a=en.trim()||eM(e);if(!a)return void f("Patient name is required before generating AI medical certificate.");let i=eU(e);f(""),h("Generating AI medical certificate PDF..."),v(async()=>{try{let t=await (0,s.B2)("/documents/medical_certificate_pdf_ai",{patient_name:a,patient_dob:i.patient_dob,patient_address:i.patient_address,patient_gender:i.patient_gender,patient_age:i.patient_age,patient_age_gender:i.patient_age_gender,doctor_note:e,analysis:l,appointment_reason:ed,appointment_notes:ep,requested_for:i.requested_for,use_doctor_template:eD,certificate_title:eD?"Medical Certificate (Doctor Template)":"Medical Certificate"});h("".concat(eD?"Template-applied ":"","medical certificate PDF ready (").concat(t.ai_used?"LLM draft":"fallback draft","): ").concat(t.document.filename)),eV(t.document.stored_path,t.document.filename||"Medical Certificate PDF"),await e0()}catch(e){eO(e,"Failed to generate AI medical certificate PDF.")}})},children:"Generate Medical Certificate (AI)"}),(0,i.jsx)(n.r,{children:"Uses Doctor Note, AI Analysis, and scheduling notes to auto-draft certificate content, then exports a Medical Certificate PDF."})]})})]})]}),(0,i.jsx)(n.Z,{title:"AI Analysis",subtitle:"Output from /analyze_case (clinical support only; doctor review required)",children:(0,i.jsx)("div",{className:"pre","data-testid":"doctor-analysis-output",style:{minHeight:428},children:l||"Case analysis output will appear here."})})]}),(0,i.jsxs)("div",{className:"page-grid columns-2",children:[(0,i.jsxs)(n.Z,{title:"AI Chat",subtitle:"Uses the same backend /chat contract as WinForms",children:[(0,i.jsx)("div",{className:"chat-box","data-testid":"doctor-chat-box",children:y.map((e,t)=>(0,i.jsxs)("p",{className:"chat-line",children:[(0,i.jsxs)("strong",{children:[e.role,":"]})," ",e.content]},"".concat(e.role,"-").concat(t)))}),(0,i.jsxs)("div",{className:"field",style:{marginTop:12},children:[(0,i.jsx)("label",{htmlFor:"chatInput",children:"Message"}),(0,i.jsx)("textarea",{id:"chatInput","data-testid":"doctor-chat-input",value:_,onChange:e=>w(e.target.value),onKeyDown:e=>{"Enter"===e.key&&(e.ctrlKey||e.metaKey)&&(e.preventDefault(),ta())},placeholder:"Ask a question about the case (Ctrl/Cmd+Enter to send)"})]}),(0,i.jsxs)("div",{className:"toolbar",children:[(0,i.jsx)("button",{className:"btn primary","data-testid":"doctor-chat-send",disabled:x,onClick:ta,children:"Send Chat"}),(0,i.jsx)("button",{className:"btn","data-testid":"doctor-chat-reset",onClick:()=>b([{role:"assistant",content:"CoPilot Symptomatologist web chat is ready. Ask about the current case or request a rewrite/summary."}]),children:"Reset Chat"})]})]}),(0,i.jsxs)(n.Z,{title:"Medication Lookup (RxNav)",children:[(0,i.jsxs)("div",{className:"field",children:[(0,i.jsx)("label",{htmlFor:"rxQuery",children:"Medication name"}),(0,i.jsx)("input",{id:"rxQuery","data-testid":"doctor-rx-query",value:D,onChange:e=>P(e.target.value),placeholder:"e.g., metformin"})]}),(0,i.jsx)("div",{className:"toolbar",children:(0,i.jsx)("button",{className:"btn","data-testid":"doctor-rx-lookup",disabled:x,onClick:()=>{D.trim()&&(f(""),h("Looking up medication in RxNav..."),v(async()=>{try{var e,t,a;let i=await (0,s.Tt)("/rxnav_lookup?query=".concat(encodeURIComponent(D.trim())));R(null!=(t=i.items)?t:[]),h("RxNav lookup returned ".concat(null!=(a=null==(e=i.items)?void 0:e.length)?a:0," item(s)."))}catch(e){eO(e,"RxNav lookup failed.")}}))},children:"Lookup"})}),(0,i.jsx)("div",{className:"list","data-testid":"doctor-rx-results",children:0===A.length?(0,i.jsx)("div",{className:"list-item",children:(0,i.jsx)(n.r,{children:"RxNav results will appear here."})}):A.map(e=>(0,i.jsx)("div",{className:"list-item",children:e},e))})]})]}),(0,i.jsxs)("div",{className:"page-grid columns-2",children:[(0,i.jsxs)(n.Z,{title:"Local Knowledge Base (Train + Ask)",children:[(0,i.jsxs)("div",{className:"field",children:[(0,i.jsx)("label",{htmlFor:"trainTags",children:"Train AI tags (comma-separated)"}),(0,i.jsx)("input",{id:"trainTags","data-testid":"doctor-train-tags",value:W,onChange:e=>X(e.target.value),placeholder:"Cardio, Endocrine, SOAP, Protocol"})]}),(0,i.jsxs)("div",{className:"toolbar",children:[(0,i.jsxs)("label",{className:"btn","data-testid":"doctor-train-upload-label",children:[Z?"Uploading...":"Train / Upload References",(0,i.jsx)("input",{hidden:!0,type:"file","data-testid":"doctor-train-upload-input",multiple:!0,accept:".pdf,.txt,.md",onChange:e=>{ti(e.target.files),e.currentTarget.value=""}})]}),(0,i.jsx)("button",{className:"btn","data-testid":"doctor-refresh-kb-list",onClick:()=>void e9(),children:"Refresh KB List"})]}),(0,i.jsxs)("div",{className:"field",children:[(0,i.jsx)("label",{htmlFor:"kbSelect",children:"Reference file"}),(0,i.jsxs)("select",{id:"kbSelect","data-testid":"doctor-kb-select",value:q,onChange:e=>E(e.target.value),children:[(0,i.jsx)("option",{value:"",children:"Select a reference file..."}),M.filter(e=>{var t;return!(null!=(t=e.tags)?t:[]).includes("patient-record")}).map(e=>(0,i.jsx)("option",{value:e.filename,children:e.filename},e.id))]})]}),(0,i.jsxs)("div",{className:"field",children:[(0,i.jsx)("label",{htmlFor:"kbQuestion",children:"Question for selected file"}),(0,i.jsx)("textarea",{id:"kbQuestion","data-testid":"doctor-kb-question",value:U,onChange:e=>G(e.target.value),placeholder:"How is this reference relevant to the current case?"})]}),(0,i.jsx)("div",{className:"toolbar",children:(0,i.jsx)("button",{className:"btn primary","data-testid":"doctor-kb-ask",disabled:x||!q,onClick:()=>{q&&(f(""),h("Querying ".concat(q,"...")),v(async()=>{try{var e;let t=await (0,s.B2)("/ask_pdf",{filename:q,history:[{role:"user",content:U||"Summarize relevance to this case"}]});K(null!=(e=t.answer)?e:""),h("KB answer received from ".concat(q,"."))}catch(e){eO(e,"KB query failed.")}}))},children:"Ask Selected Reference"})}),(0,i.jsx)("div",{className:"pre","data-testid":"doctor-kb-answer",children:H||"KB answer output will appear here."}),(0,i.jsxs)(n.r,{children:["Trained document count: ",M.filter(e=>{var t;return!(null!=(t=e.tags)?t:[]).includes("patient-record")}).length]})]}),(0,i.jsxs)(n.Z,{title:"Medical References (PubMed + ClinicalTrials + RxNav)",children:[(0,i.jsxs)("div",{className:"field",children:[(0,i.jsx)("label",{htmlFor:"refQuery",children:"Keywords / condition / diagnosis"}),(0,i.jsx)("input",{id:"refQuery","data-testid":"doctor-ref-query",value:F,onChange:e=>T(e.target.value),placeholder:"e.g., diabetic ketoacidosis management adult"})]}),(0,i.jsxs)("div",{className:"toolbar",children:[(0,i.jsx)("button",{className:"btn accent","data-testid":"doctor-ref-fetch",disabled:x,onClick:()=>{F.trim()&&(f(""),h("Fetching medical references..."),v(async()=>{try{var e,t;let a=await (0,s.B2)("/medical_references",{query:F,max_pubmed:6,max_trials:5,max_rxnorm:15,summarize:!0,max_summary_paragraphs:3});O(null!=(e=a.summary_text)?e:""),L(null!=(t=a.report_text)?t:""),h("Medical references report ready.")}catch(e){eO(e,"Medical references lookup failed.")}}))},children:"Fetch References"}),(0,i.jsx)("button",{className:"btn","data-testid":"doctor-ref-clear",onClick:()=>{O(""),L("")},children:"Clear"})]}),(0,i.jsx)("div",{className:"pre","data-testid":"doctor-ref-summary",children:I||"AI evidence summary will appear here."}),(0,i.jsx)("div",{className:"pre","data-testid":"doctor-ref-report",style:{maxHeight:360},children:B||"Detailed references report will appear here."})]})]}),(0,i.jsx)(n.Z,{title:"Saved Patient Records",subtitle:"Doctor records plus assistant intakes from host storage",children:(0,i.jsxs)("div",{className:"stack",style:{gap:12},children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("h3",{style:{margin:0},children:"Doctor Records"}),(0,i.jsx)("div",{className:"list","data-testid":"doctor-patient-records-list",children:0===N.length?(0,i.jsx)("div",{className:"list-item",children:(0,i.jsx)(n.r,{children:"No doctor records loaded yet."})}):N.map(e=>(0,i.jsxs)("div",{className:"list-item","data-testid":"doctor-patient-record-item",children:[(0,i.jsx)("strong",{children:e.title}),(0,i.jsx)(n.r,{children:e.filename}),(0,i.jsx)(n.r,{children:e.created_at}),(0,i.jsxs)("div",{className:"toolbar",children:[(0,i.jsx)("button",{className:"btn","data-testid":"doctor-open-record-file-".concat(e.id),onClick:()=>eV("/storage/".concat((e.path||"").replace(/^\/+/,"")),e.filename||e.title||"Doctor record"),children:"Open file"}),(0,i.jsx)("button",{className:"btn","data-testid":"doctor-append-record-".concat(e.id),onClick:()=>eQ("[Patient record selected]\n".concat(e.title,"\n").concat(e.filename)),children:"Append Reference to Note"})]})]},e.id))})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("h3",{style:{margin:0},children:"Assistant Intakes"}),(0,i.jsx)("div",{className:"list","data-testid":"doctor-intake-records-list",children:0===C.length?(0,i.jsx)("div",{className:"list-item",children:(0,i.jsx)(n.r,{children:"No assistant intakes loaded yet."})}):C.map(e=>(0,i.jsxs)("div",{className:"list-item","data-testid":"doctor-intake-record-item",children:[(0,i.jsx)("strong",{children:e.full_name||"(Unnamed patient)"}),(0,i.jsxs)(n.r,{children:["DOB: ",e.date_of_birth||"-"]}),(0,i.jsxs)(n.r,{children:["Chief complaint: ",e.chief_complaint||"-"]}),(0,i.jsx)(n.r,{children:e.created_at}),(0,i.jsxs)("div",{className:"toolbar",children:[(0,i.jsx)("button",{className:"btn","data-testid":"doctor-append-intake-".concat(e.id),onClick:()=>void e3(e.id),children:"Append Intake to Note"}),(0,i.jsx)("button",{className:"btn primary","data-testid":"doctor-open-analyze-intake-".concat(e.id),onClick:()=>e4(e.id),children:"Open + Analyze"}),(0,i.jsx)("button",{className:"btn","data-testid":"doctor-open-intake-pdf-".concat(e.id),onClick:()=>e6(e.id),children:"Open intake PDF"})]})]},e.id))})]})]})}),eF?(0,i.jsx)("div",{className:"doc-modal-backdrop","data-testid":"doctor-document-modal",onClick:()=>eT(null),children:(0,i.jsxs)("div",{className:"doc-modal",onClick:e=>e.stopPropagation(),children:[(0,i.jsxs)("div",{className:"doc-modal-header",children:[(0,i.jsx)("strong",{children:eF.title}),(0,i.jsxs)("div",{className:"toolbar",children:[(0,i.jsx)("button",{className:"btn primary","data-testid":"doctor-document-print",onClick:()=>{let e=eI.current;try{var t,a;null==e||null==(t=e.contentWindow)||t.focus(),null==e||null==(a=e.contentWindow)||a.print();return}catch(e){}(null==eF?void 0:eF.url)&&(window.open(eF.url,"_blank","noopener,noreferrer"),h("Opened document in a new tab. Use browser print there."))},children:"Print"}),(0,i.jsx)("button",{className:"btn","data-testid":"doctor-document-open-new-tab",onClick:()=>{(null==eF?void 0:eF.url)&&window.open(eF.url,"_blank","noopener,noreferrer")},children:"View in browser tab"}),(0,i.jsx)("button",{className:"btn danger","data-testid":"doctor-document-close-viewer",onClick:()=>eT(null),children:"Close"})]})]}),(0,i.jsx)("iframe",{ref:eI,src:eF.url,title:eF.title,style:{width:"100%",minHeight:"70vh",border:"1px solid rgba(16, 32, 25, 0.14)",borderRadius:12,background:"white"}}),(0,i.jsx)(n.r,{children:'If preview is blocked by browser/PDF plugin, click "View in browser tab" then print there.'})]})}):null]})}}},e=>{var t=t=>e(e.s=t);e.O(0,[874,441,684,358],()=>t(4872)),_N_E=e.O()}]);